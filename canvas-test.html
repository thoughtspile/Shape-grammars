<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
    </head>
    <body style= 'margin: 0; width: 100%'>
        <canvas id="canvas" style= 'width: 100%; height: 300px;'></canvas>
        <script src = utils.js></script>
        <script src = gen.js></script>
        <script src = canvas-render.js></script>
        <script>
            var canvas = document.getElementById('canvas');
            setupCanvas(canvas);

            var distr = gen.addState().resize(canvas.width, canvas.height);
            var lot = gen.addState().resize(30, 100);
            var house = gen.addState(function() {
                this.color = '#' + randi(0, Math.pow(256, 3)).toString(16);
            });
            var floor = gen.addState(function(parent) {
                this.color = parent.color;
            });
            var wall = gen.addState(function(parent) {
                this.color = parent.color;
            }).resize(30, 20);
            var win = gen.addState(function() {
                this.color = 'rgba(20, 20, 20, .7)';
            }).mv(0, 6).resize(6, 8);
            var roof = gen.addState();
            var roofTile = gen.addState(function(parent) {
                this.color = 'rgb(200, ' + randi(120, 150) + ', 0)';
            }).resize(2, 2);

            var street = gen.addState(function() {
                this.color = 'gray';
            }).resize(30, 1);
            var tree = gen.addState().mv(15, 0);
            var trunk = gen.addState(function() {
                this.color = 'brown';
            }).mv(-2, 0).resize(4, 20);
            var crown = gen.addState(function() {
            }).mv(0, 20);
            var leaf = gen.addState(function() {
                this.color = 'rgb(0,' + randi(100, 200) + ',0)';
            }).resize(3, 3);

            gen.init();
            gen.addRule(gen._init, [distr])
                .repeat(distr, 0, lot)
                .addRule(lot, [house])
                .addRule(lot, [street, tree])
                .addRule(house, rep(3, floor).map(function(succ, i) {
                    return succ.mv(0, 20 * i);
                }).concat(roof.mv(0, 60)))
                .addRule(floor, [wall, win.mv(5, 6), win.mv(19, 6)])
                .addRule(house, [floor, roof.mv(0, 20)])
                .addRule(roof, rep(30 * 20 / 4, roofTile).map(function(tile, i) {
                    var row = Math.floor(i / 10);
                    return tile.mv(2 * row, 2 * (i - 10 * row));
                }))
                .addRule(tree, [trunk, crown])

            for (var i = 0; i < 10; i++)
                gen.addRule(crown, rep(120, leaf).map(function(leaf) {
                    return leaf.mv(randi(-12, 12), randi(-10, 15));
                }));

            render(canvas, gen.apply());
            //renderBlocks(canvas, tile())
        </script>
    </body>
</html>
