<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
</head>
<body style= 'margin: 0; width: 100%'>
    <canvas id="canvas" style= 'width: 100%; height: 300px;'></canvas>
    <button id = 'runBtn'>run</button>

    <script src = utils.js></script>
    <script src = gen.js></script>
    <script src = canvas-render.js></script>
    <script>
        var canvas = document.getElementById('canvas');
        setupCanvas(canvas);

        // descriptions
        var shadow = gen.addState(function() {
            this.color = 'rgba(0,0,0,.4)';
        });
        var distr = gen.addState().resize(canvas.width, canvas.height);
        var lot = gen.addState().resize(30, 100);

        var house = gen.addState(function() {
            this.color = randClr(null, null, null, .7);
        });
        var floor = gen.addState().resize(30, 20);
        var wall = gen.addState().resize(30, 20);
        var door = gen.addState(function() {
            this.color = 'rgba(20, 20, 20, .7)';
        }).resize(7, 14);
        var shopShade =  gen.addState(function() {
            this.color = randClr(null, null, null, 1);
        }).resize(30, 7).mv(0, 13);

        var win = gen.addState().mv(0, 6).resize(7, 8);
        var winGlass = gen.addState(function() {
            this.color = randClr([20, 80], [40, 100], [20, 50], .8);
        }).resize(7, 8);
        var vertFrame = gen.addState(function() {
            this.color = 'rgba(150, 140, 60, .7)';
        }).resize(1, 8).mv(3, 0);
        var horzFrame = gen.addState(function() {
            this.color = 'rgba(150, 140, 60, .7)';
        }).resize(7, 1).mv(0, 4); // why no mv before resize

        var roof = gen.addState().resize(30, 15);
        var roofStruct = gen.addState().resize(30, 15);
        var roofTileRow = gen.addState()
        var roofTile = gen.addState(function() {
            this.color = randClr(200, [80, 180], 0, 1);
        }).resize(2, 2);

        var street = gen.addState(function() {
            this.color = 'gray';
        }).resize(30, 1);
        var tree = gen.addState().mv(15, 0);
        var trunk = gen.addState(function() {
            this.color = 'rgb(130, 70, 0)';
        }).mv(-2, 0).resize(4, 20);
        var crown = gen.addState().mv(0, 20);
        var leaf = gen.addState(function() {
            this.color = randClr(40, [100, 200], 0, .7);
        }).resize(3, 3);

        // grammar
        gen.addRule(gen._init, [distr])
            .repeat(distr, 0, [lot])
            .addRule(lot, [house])
            .addRule(lot, [street, tree])
            .split(house, 1, [floor, floor, floor, roof])
            .split(house, 1, [floor, floor, roof])
            .addRule(floor, [wall, win.mv(5, 6), win.mv(18, 6)])
            .addRule(floor, [wall, win.mv(5, 6), door.mv(18, 0), shopShade], function(floor) {
                return floor.locator == 0;
            })
            .addRule(win, [
                shadow.resize(7, 2).mv(0, 6),
                winGlass,
                horzFrame,
                vertFrame])
            .addRule(roof, [shadow.resize(30, 2).mv(0, -2), roofStruct])
            .repeat(roofStruct, 1, [roofTileRow.resize(32, 2).mv(-1, 1)])
            .addRule(roofStruct, rep(10, roofTileRow).map(function(row, i) {
                return row.resize(32 - 2 * i, 2).mv(i - 1, i);
            }))
            .addRule(roofStruct, [roofTileRow.resize(34, 2).mv(-2, 0)])
            .repeat(roofTileRow, 0, [roofTile])
            .addRule(tree, [trunk, crown, crown, crown])

        for (var i = 0; i < 10; i++)
            gen.addRule(crown, rep(40, leaf).map(function(leaf) {
                return leaf.mv(randi(-12, 12), randi(-10, 15));
            })).addRule(crown, [crown.mv(randi(-3, 3), randi(-3, 3))])

        function run() { render(canvas, gen.apply()); };
        document.getElementById('runBtn').addEventListener('click', run);
        run();
    </script>
</body>
</html>
